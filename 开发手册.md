# 技术栈

1. 字节开源HTTP框架 -  hertz
2. 字节RPC框架 - Kitex
3. IDL - protobuf  / Apache Thrift
4. 代码生成工具 - cwgo
   1. [protobuf文档](https://protobuf.dev/programming-guides/proto3/)
5. 注册中心 - consul
6. 数据库 - mysql



---

# 开发流程

## 1. 新建项目

```shell
go mod init github.com/hourhl/Qmall
go get -u github.com/cloudwego/hertz

# 快速启动框架
mkdir hello-world
cd hello-world
new-item hello-world.go
# 粘贴文档中的快速启动示例代码
# 修改一下h.GET的逻辑
# 根目录下运行
cd ..
go mod tidy
cd hello-world
go run hello-world.go
```

![image-20241109231402266](开发手册.assets/image-20241109231402266.png)

附：修改一下h.GET的逻辑如下

```go
h.GET("/hello", func(ctx context.Context, c *app.RequestContext) {
		c.Data(consts.StatusOK, consts.MIMETextPlain, []byte("hello world"))
	})s
```

* 设置远程仓库

  ```shell
  git remote add origin https://github.com/hourhl/Qmall.git
  # 由于本地分支是master，考虑到github默认分支是main，运行以下指令进行分支切换
  # git branch main
  # git checkout main
  git add .
  git commit -m "start hertz with hello world and copy protobuf file in idl/"
  git pull origin main --allow-unrelated-histories
  git push -u origin main
  ```

  

## 2. 接口

* 新建idl文件夹，从项目方案中copy对应的接口文档（finish）

* 利用 cwgo生成代码

  ```shell
  # Windows Powershell配置goproxy
  # 启用 Go Modules 功能
  $env:GO111MODULE="on"
  # 配置 GOPROXY 环境变量
  $env:GOPROXY="https://goproxy.io"
  
  # 安装cwgo
  # 注意：gcc和g++必须是64位才能编译成功
  go install github.com/cloudwego/cwgo@latest
  cwgo --version
  cwgo version v0.1.2
  
  
  # 安装protoc
  # github下载安装包并解压，添加环境变量bin文件夹
  protoc --version
  libprotoc 28.3
  
  # 生成代码
  mkdir src
  cd src
  # 生成的命令如下：不确定
  cwgo server -i ../idl --type RPC --module github.com/hourhl/Qmall/src --service mall --idl ../idl/*
  
  go mod tidy
  go work use .
  got run 
  ```





---

## 3. 前端开发

### 技术栈

1. 框架 - 本次项目的演示页面几乎不使用js，基本只使用html和css
2. 库- UI组件（bootstrap） /  图形库（Fontawesome）
3. 页面骨架 - go template

### 开发步骤

1. 利用hertz生成代码

   1. 参照hertz usage proto，在idl文件夹下放置api.proto,在idl/frontend文件夹下放置home.proto

      ```shell
      cd .\app\frontend\
      cwgo server --type HTTP --idl ..\..\idl\frontend\home.proto --service frontend -module github.com/hourhl/Qmall/app/frontend -I ..\..\idl\
      ```
      
   2. 确认代码能够运行
   
      ```shell
      go mod tidy
      go run .
      ```
   
      ![image-20241114202141480](开发手册.assets/image-20241114202141480.png)
   
2. 修改代码 - 读取模板文件[参考文档](https://www.cloudwego.cn/docs/hertz/tutorials/basic-feature/render/)

   ```shell
   # main.go - func:main
   # h.Spin()前加上
   h.LoadHTMLGlob("template/*")
   
   # app/frontend文件夹下新建template文件夹
   # 新建home.tmpl文件
   # 随便写点什么
   this is home
   
   # app/frontend/biz/handler/home
   # 修改home_service.go，让其加载模板home.tmpl
   # 注释 utils.SendSuccessResponse(ctx, c, consts.StatusOK, resp)
   # 加上
   c.HTML(consts.StatusOK, "home.tmpl", resp)
   
   # 启动 go run .
   # 访问localhost:8080
   # 可以看到页面显示 this is home
   ```

3. 编写前端页面(bootstrap)

   1. 引入框架 - [下载](https://getbootstrap.com/docs/5.3/getting-started/download/)编译好的文件，并加载到项目中

      ```shell
      # app/frontend下新建文件夹static
      # static中再分别新建css和js文件夹
      # 解压下载的文件，将bootstrap.min.css拷贝到css下，将bootstrap.bundle.min.js拷贝到js下
      ```

   2. 指定静态目录 - [参考文档](https://getbootstrap.com/docs/5.3/getting-started/introduction/)引入css和js到home.tmpl中

      ```shell
      # home.tmpl
      # 修改bootstrap.min.css和bootstrap.bundle.min.js的引入路径
      
      # main.go - func:main
      # h.Spin()前加上
      h.Static("/static", "./")
      # 用于引入静态目录
      
      # 确认框架启动成功
      go run .
      ```

      ![image-20241114205038494](开发手册.assets/image-20241114205038494.png)

   3. 页面设计

      ![image-20241114205353435](开发手册.assets/image-20241114205353435.png)

   4. 导航栏（header）

      ```shell
      # copy bootstrap的navbar导航栏，并进行修改
      # 利用fontawesome来引入图标 参考文档 https://fontawesome.com/docs
      ```
      
   5. footer
   
   6. main
   
   7. template分隔
   
   8. 动态渲染 - 修改app/frontend/biz/service/home.go和app/frontend/biz/handler/home/home_service.go
   
      ```shell
      # 业务逻辑主要在service文件夹下实现
      ```
   
      



---



## 4. 后端开发

### 用户服务

#### 基本功能

1. 创建用户（注册）
2. 登录
3. 获取用户身份信息



#### 实现思路

cwgo生成代码 -> 定义user模型 -> 完善service逻辑 -> 单元测试



#### 开发步骤

1. 修改user.proto

   在LoginResp中加入一个token字段，作为接下来进行token校验的

   ```shell
   syntax="proto3";
   
   package user;
   
   option go_package="/user";
   
   service UserService {
     rpc Register(RegisterReq) returns (RegisterResp) {}
     rpc Login(LoginReq) returns (LoginResp) {}
   }
   
   message RegisterReq {
     string email = 1;
     string password = 2;
     string confirm_password = 3;
   }
   
   message RegisterResp {
     int32 user_id = 1;
   }
   
   message LoginReq {
     string email= 1;
     string password = 2;
   }
   
   message LoginResp {
     string token = 1;
   }
   ```

2. 利用cwgo分别生成服务端和客户端代码

   ```shell
   # Qmall根目录下新建一个rpc_gen文件夹，存放生成的客户端代码
   cd rpc_gen
   go mod init github.com/hourhl/Qmall/rpc_gen
   cwgo client --type RPC --service user --module github.com/hourhl/Qmall/rpc_gen -I ..\idl\ --idl ..\idl\user.proto
   
   # 生成服务端代码，并不再维护客户端代码
   cd app/user
   # 新建一个模块
   go mod init github.com/hourhl/Qmall/app/user
   cwgo server --type RPC --service user --module github.com/hourhl/Qmall/app/user --pass "-use github.com/hourhl/Qmall/rpc_gen/kitex_gen" -I ..\..\idl\ --idl ..\..\idl\user.proto
   
   # 在服务端的go.mod中手动引入rpc_gen的路径
   github.com/hourhl/Qmall/rpc_gen => ../../rpc_gen
   
   go mod tidy
   ```

3. 定义user模型(app/user/biz/model/user.go)

4. 服务注册[参考文档](https://www.cloudwego.io/zh/docs/kitex/tutorials/service-governance/service_discovery/consul/)

   ```shell
   # 引入组件
   go get github.com/kitex-contrib/registry-consul
   ```

5. 修改mysql的配置文件

   1. 修改/app/user/biz/dal/mysql/init.go，使其从环境变量中读取配置信息，并配置自动迁移

   2. 修改/app/user/conf/test/conf.yaml中mysql的dsn，并把registry的端口为8500，将文件内容复制到/app/user/conf/dev/conf.yaml和/app/user/conf/online/conf.yaml中

   3. 新建环境变量的配置文件 /app/user/.env

   4. 加载环境变量配置文件 /app/user/main.go

      ```go
      // main 函数首行加上
      godotenv.Load()
      mysql.Init()
      ```

      ```shell
      # 加载包
      cd /app/user
      go get github.com/joho/godotenv
      go mod tidy
      ```

6. 实现注册逻辑

   1. 引入加密组件

      ```shell
      go get golang.org/x/crypto
      ```

   2. /app/user/biz/model定义用户模型，并定义和往数据库中插入用户信息的函数

   3. /app/user/biz/service实现用户逻辑

   4. 单元测试

      1. 将/app/user/biz/dal/mysql/init.go中的dsn的路径从读取配置文件改为直接路径

      2. 启动docker

      3. 启动user模块

      4. 手动在register_test.go加载环境变量和初始化mysql，运行TestRegister_Run函数

         

7. 实现登录逻辑

   1. 基本逻辑同注册
   2. 利用auth模块获得token(todo)
   3. 单元测试(todo)



### 认证中心

#### 基本功能

1. 分发身份令牌
2. 校验身份令牌

#### 实现思路

cwgo生成代码 -> 修改controller -> 完善service -> 与数据库交互

[参考文档](https://www.cnblogs.com/YLTFY1998/p/16898513.html)



#### 开发步骤

1. 修改auth.proto

   ```protobuf
   syntax = "proto3";
   
   package auth;
   
   option go_package = "auth";
   
   // 认证服务
   service AuthService {
       // 生成令牌
       rpc DeliverTokenByRPC (DeliverTokenReq) returns (DeliveryResp);
       // 验证令牌
       rpc VerifyTokenByRPC (VerifyTokenReq) returns (VerifyResp);
   }
   
   // 请求生成令牌
   message DeliverTokenReq {
       int32 user_id = 1; // 用户ID
   }
   
   // 请求验证令牌
   message VerifyTokenReq {
       string token = 1; // 令牌
   }
   
   // 响应生成令牌
   message DeliveryResp {
       string token = 1; // 生成的令牌
   }
   
   // 响应验证令牌
   message VerifyResp {
       bool res = 1; // 验证结果
   }
   ```

2. 利用cwgo分别生成客户端代码和服务端代码

   ```shell
   # Qmall根目录下新建一个rpc_gen文件夹，存放生成的客户端代码
   cd rpc_gen
   cwgo client --type RPC --service auth --module github.com/hourhl/Qmall/rpc_gen -I ..\idl\ --idl ..\idl\auth.proto
   
   # 生成服务端代码，并不再维护客户端代码
   cd app/auth
   # 新建一个模块
   go mod init github.com/hourhl/Qmall/app/auth
   cwgo server --type RPC --service auth --module github.com/hourhl/Qmall/app/auth --pass "-use github.com/hourhl/Qmall/rpc_gen/kitex_gen" -I ..\..\idl\ --idl ..\..\idl\auth.proto
   
   # 在服务端的go.mod中手动引入rpc_gen的路径
   github.com/hourhl/Qmall/rpc_gen => ../../rpc_gen
   
   go mod tidy
   ```

3. 引入jwt

   ```shell
   go get github.com/hertz-contrib/jwt
   ```



### 商品服务

#### 基本功能

* 查询商品信息（单个商品、批量商品）

#### 实现思路

 生成代码 -> 定义模型 -> 实现业务逻辑 -> 单元测试

#### 开发步骤

1. product.proto定义接口

   ```protobuf
   syntax = "proto3";
   
   package product;
   
   option go_package = "/product";
   
   service ProductCatalogService {
     rpc ListProducts(ListProductsReq) returns (ListProductsResp) {}
     rpc GetProduct(GetProductReq) returns (GetProductResp) {}
     rpc SearchProducts(SearchProductsReq) returns (SearchProductsResp) {}
   }
   
   message ListProductsReq{
     int32 page = 1;
     int64 pageSize = 2;
   
     string categoryName = 3;
   }
   
   message Product {
     uint32 id = 1;
     string name = 2;
     string description = 3;
     string picture = 4;
     float price = 5;
   
     repeated string categories = 6;
   }
   
   message ListProductsResp {
     repeated Product products = 1;
   }
   
   message GetProductReq {
     uint32 id = 1;
   }
   
   message GetProductResp {
     Product product = 1;
   }
   
   message SearchProductsReq {
     string query = 1;
   }
   
   message SearchProductsResp {
     repeated Product results = 1;
   }
   ```

2. cwgo分别生成服务端代码和客户端代码

   ```shell
   # Qmall根目录下新建一个rpc_gen文件夹，存放生成的客户端代码
   cd rpc_gen
   cwgo client --type RPC --service product --module github.com/hourhl/Qmall/rpc_gen -I ..\idl\ --idl ..\idl\product.proto
   
   # 生成服务端代码，并不再维护客户端代码
   cd app/product
   # 新建一个模块
   go mod init github.com/hourhl/Qmall/app/product
   cwgo server --type RPC --service product --module github.com/hourhl/Qmall/app/product --pass "-use github.com/hourhl/Qmall/rpc_gen/kitex_gen" -I ..\..\idl\ --idl ..\..\idl\product.proto
   
   # 在服务端的go.mod中手动引入rpc_gen的路径
   github.com/hourhl/Qmall/rpc_gen => ../../rpc_gen
   
   go mod tidy
   ```

3. 定义product和category模型(app/user/biz/model/product.go 和 app/user/biz/model/category.go)

4. 服务注册[参考文档](https://www.cloudwego.io/zh/docs/kitex/tutorials/service-governance/service_discovery/consul/)

   ```shell
   # 引入组件
   go get github.com/kitex-contrib/registry-consul
   ```

   ```go
   // 在/app/product/main.go的kitexInit()中加入
   	r, err := consul.NewConsulRegister(conf.GetConf().Registry.RegistryAddress[0])
   	if err != nil {
   		log.Fatal(err)
   	}
   	opts = append(opts, server.WithRegistry(r))
   ```

   

5. 修改mysql的配置文件

   1. 修改/app/product/biz/dal/mysql/init.go，使其从环境变量中读取配置信息，并配置自动迁移

   2. 修改/app/product/conf/test/conf.yaml中mysql的dsn，并把registry的端口为8500，将文件内容复制到/app/product/conf/dev/conf.yaml和/app/product/conf/online/conf.yaml中

   3. 新建环境变量的配置文件 /app/product/.env

   4. 加载环境变量配置文件 /app/product/main.go

      ```go
      // main 函数首行加上
      godotenv.Load()
      mysql.Init()
      ```

      ```shell
      # 加载包
      cd /app/product
      go get github.com/joho/godotenv
      go mod tidy
      ```

6. 实现根据商品id查找 / 根据名称查找分类 / 根据相关信息搜索

7. 单元测试（todo）

   1. 将/app/product/biz/dal/mysql/init.go中的dsn的路径从读取配置文件改为直接路径
   2. 启动docker
   3. 启动product模块
   4. 手动在register文件中加载环境变量和初始化mysql，运行Test函数






